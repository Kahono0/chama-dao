import { Inter } from "next/font/google";
import styles from "@/styles/Login.module.css";
import homeStyles from "@/styles/Home.module.css";
import Head from "next/head";
import Logo from "../components/logo";
import ArrowDownwardIcon from "@mui/icons-material/ArrowDownward";
import React, { useEffect, useState } from "react";
import { User } from "@/utils/types";
import createUser from "@/utils/createUser";

const inter = Inter({ subsets: ["latin"] });

export default function SignUp() {
  const [ethereum, setEthereum] = useState(null);
  const [account, setAccount] = useState(null);
  const [error, setError] = useState(false);

  useEffect(() => {
    if (typeof window !== "undefined") {
      if ((window as any).ethereum) {
        if (localStorage.getItem("token") != null) {
          window.location.href = "/landing";
        }
        setEthereum((window as any).ethereum);
      } else {
        setError(true);
      }
    }
  }, []);

  const connectWallet = async () => {
    if (ethereum == null) {
      return;
    }

    try {
      const accounts = await (ethereum as any).request({
        method: "eth_requestAccounts",
      });
      setAccount(accounts[0]);
    } catch (error) {
      console.log(error);
    }
  };

  const handleInput = (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();

    if (account == null) {
      return;
    }

    if (!e.currentTarget.username.value) {
      return;
    }

    const user: User = {
      name: e.currentTarget.username.value,
      address: account,
    };

    createUser(user).then((res) => {
      if(res){
        window.location.href = "/landing";
      }
      return;
    });
  };

  return (
    <>
      <Head>
        <title>Chama DAO</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={homeStyles.main}>
        <Logo />
        <div className={`${styles.login} ${inter.className}`}>
          <p className={styles.title}>
            Before we continue, we would like you to choose a username, it will
            be used in place of your wallet address when your colleagues cannot
            remember it.
          </p>
          <div className={styles.form}>
            <form autoComplete="off" onSubmit={handleInput}>
              <div className={styles.input}>
                <input
                  autoComplete="false"
                  name="hidden"
                  type="text"
                  style={{ display: "none" }}
                />
                <label htmlFor="username">Username</label>
                <input
                  type="text"
                  name="username"
                  id="username"
                  autoComplete="false"
                  required
                />
                <p>Choose a username to help people identify you</p>
              </div>

              {error == true ? (
                <p className={styles.desc}>
                  You need to have metamask wallet on your browser to continue.
                  Please click{" "}
                  <a
                    href="https://metamask.io/download.html"
                    target="_blank"
                    style={{ color: "blue" }}
                  >
                    here
                  </a>{" "}
                  to download and configure, Thank you!
                </p>
              ) : (
                <>
                  {!account == true ? (
                    <>
                      <button
                        className={styles.connect}
                        onClick={() => connectWallet()}
                      >
                        Connect your wallet
                      </button>
                      <p className={styles.desc}>
                        You should have configured metamask on your browser
                        before clicking this button
                      </p>
                      <p className={styles.desc}>
                        If you have not, please click{" "}
                        <a
                          href="https://metamask.io/download.html"
                          target="_blank"
                          style={{ color: "blue" }}
                        >
                          here
                        </a>{" "}
                        to download metamask
                      </p>
                    </>
                  ) : (
                    <>
                      <br />
                      <br />
                      <p>{account}</p>
                    </>
                  )}
                  <br />
                  <br />
                  <br />
                  <br />

                  <p className={styles.desc}>
                    By clicking <b>Join Now</b> you agree to our{" "}
                    <a
                      href="https://metamask.io/download.html"
                      target="_blank"
                      style={{ color: "blue" }}
                    >
                      Terms of Service
                    </a>{" "}
                    and{" "}
                    <a
                      href="https://metamask.io/download.html"
                      target="_blank"
                      style={{ color: "blue" }}
                    >
                      Privacy Policy
                    </a>
                  </p>

                  <button className={styles.button}>Join Now</button>
                </>
              )}
            </form>
          </div>
        </div>
      </main>
    </>
  );
}
